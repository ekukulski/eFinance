<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:KukiFinance.Converters"
             x:Class="KukiFinance.Pages.BmoCheckRegisterPage"
             Title="BMO Check Register">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:AmountFormatConverter x:Key="AmountFormatConverter" />
            <converters:AmountColorConverter x:Key="AmountColorConverter" />
            <converters:AlternatingRowColorConverter x:Key="AlternatingRowColorConverter"
                                                     EvenColor="PaleGreen"
                                                     OddColor="PaleGoldenrod" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <VerticalStackLayout Padding="20" Spacing="16">
        <HorizontalStackLayout Spacing="16" Margin="0,10,0,0">
            <Button Text="Add New Transactions"
                    x:Name="AddTransactionsButton"
                    BackgroundColor="IndianRed"
                    TextColor="Black"
                    FontSize="20"
                    WidthRequest="225"
                    Clicked="AddTransactionsButton_Clicked" />
            <Button Text="Manual Transaction Entry"
                    x:Name="ManualTransactionEntryButton"
                    BackgroundColor="CadetBlue"
                    TextColor="Black"
                    FontSize="20"
                    WidthRequest="270"
                    Clicked="ManualTransactionEntryButton_Clicked" />
            <Button Text="Edit Transaction"
                    x:Name="EditButton"
                    BackgroundColor="LightBlue"
                    TextColor="Black"
                    FontSize="20"
                    WidthRequest="190"
                    Clicked="EditButton_Clicked" />
            <Button Text="Copy Transaction Description" 
                    x:Name="CopyTransactionDescription"
                    Background="LightSteelBlue"
                    TextColor="Black"
                    FontSize="20"
                    WidthRequest="300"
                    Clicked="CopyDescriptionButton_Clicked" />
            <Button Text="Delete Transaction"
                    x:Name="DeleteTransaction"
                    Background="PaleVioletRed"
                    TextColor="Black"
                    FontSize="20"
                    WidthRequest="210"
                    Clicked="DeleteTransactionButton_Clicked" />
            <Button Text="Return"
                    x:Name="ReturnButton"
                    BackgroundColor="PaleGoldenrod"
                    TextColor="Black"
                    FontSize="20"
                    WidthRequest="96"
                    Clicked="ReturnButton_Clicked" />
        </HorizontalStackLayout>

        <!-- Subtitle and Balance -->
        <Grid ColumnDefinitions="145,120" Margin="0,10,0,10">
            <Label Text="Check Balance =" FontSize="18" FontAttributes="Bold" VerticalOptions="Center" />
            <Label
                Text="{Binding CurrentBalance, Converter={StaticResource AmountFormatConverter}}"
                FontSize="18"
                TextColor="{Binding CurrentBalance, Converter={StaticResource AmountColorConverter}}"
                Grid.Column="1"
                FontAttributes="Bold"
                TextDecorations="Underline"
                HorizontalOptions="Start"
                VerticalOptions="Center" />
        </Grid>

        <!-- Sorting Instruction -->
        <Label Text="Tap a column header (⇅) to sort by that column." 
               FontSize="14" 
               TextColor="Gray"
               HorizontalOptions="Start"
               Margin="0"/>
        
        <!-- Keyboard Instruction -->
        <Label Text="Select a row in the table then press ENTER key to go to top of table display." 
               FontSize="14" 
               TextColor="Gray"
               HorizontalOptions="Start"
               Margin="0"/>
        <Label Text="Select a row in the table then press END key to go to bottom of table display." 
               FontSize="14" 
               TextColor="Gray"
               HorizontalOptions="Start"
               Margin="0"/>

        <SearchBar
            x:Name="RegisterSearchBar"
            Placeholder="Search transactions..."
            Text="{Binding SearchText, Mode=TwoWay}"
            Margin="0,0,0,10"
            FontSize="18"
            HorizontalOptions="Start"/>

        <!-- Scrollable Table -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Table Header with Sort Icons and Tappable Labels -->
            <Grid Grid.Row="0" ColumnDefinitions="120,500,360,120,120,120">
                <Label Grid.Column="0" FontAttributes="Bold">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="DATE " />
                            <Span Text="⇅" FontSize="12" />
                        </FormattedString>
                    </Label.FormattedText>
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortCommand}" CommandParameter="Date" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Grid.Column="1" FontAttributes="Bold">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="DESCRIPTION " />
                            <Span Text="⇅" FontSize="12" />
                        </FormattedString>
                    </Label.FormattedText>
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortCommand}" CommandParameter="Description" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Grid.Column="2" FontAttributes="Bold">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="CATEGORY " />
                            <Span Text="⇅" FontSize="12" />
                        </FormattedString>
                    </Label.FormattedText>
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortCommand}" CommandParameter="Category" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Grid.Column="3" FontAttributes="Bold">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="CHECK NUMBER " />
                            <Span Text="⇅" FontSize="12" />
                       </FormattedString>
                    </Label.FormattedText>
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortCommand}" CommandParameter="CheckNumber" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Grid.Column="4" FontAttributes="Bold" HorizontalTextAlignment="End">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="AMOUNT " />
                            <Span Text="⇅" FontSize="12" />
                        </FormattedString>
                    </Label.FormattedText>
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortCommand}" CommandParameter="Amount" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Grid.Column="5" FontAttributes="Bold" HorizontalTextAlignment="End">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="BALANCE " />
                            <Span Text="⇅" FontSize="12" />
                        </FormattedString>
                    </Label.FormattedText>
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SortCommand}" CommandParameter="Balance" />
                    </Label.GestureRecognizers>
                </Label>
            </Grid>

            <!-- Table Body (Scrollable) -->
            <CollectionView Grid.Row="1"
                x:Name="RegisterCollectionView"
                ItemsSource="{Binding FilteredEntries}"
                HeightRequest="925"
                VerticalScrollBarVisibility="Always"
                SelectionMode="Single"
                SelectionChanged="RegisterCollectionView_SelectionChanged">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="120,500,360,120,120,120" Padding="0">
                            <Grid.Background>
                                <MultiBinding Converter="{StaticResource AlternatingRowColorConverter}">
                                    <Binding />
                                    <!-- The item itself -->
                                    <Binding Path="BindingContext.Entries" Source="{x:Reference RegisterCollectionView}" />
                                </MultiBinding>
                            </Grid.Background>
                            <Label Grid.Column="0" Text="{Binding Date, StringFormat='{0:yyyy-MM-dd}'}" />
                            <Label Grid.Column="1" Text="{Binding Description}" />
                            <Label Grid.Column="2" Text="{Binding Category}" />
                            <Label Grid.Column="3" Text="{Binding CheckNumber}" />
                            <Label Grid.Column="4"
                   Text="{Binding Amount, Converter={StaticResource AmountFormatConverter}}"
                   TextColor="{Binding Amount, Converter={StaticResource AmountColorConverter}}"
                   HorizontalTextAlignment="End"/>
                            <Label Grid.Column="5"
                   Text="{Binding Balance, Converter={StaticResource AmountFormatConverter}}"
                   TextColor="{Binding Balance, Converter={StaticResource AmountColorConverter}}"
                   HorizontalTextAlignment="End"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </VerticalStackLayout>
</ContentPage>