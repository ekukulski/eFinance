<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:eFinance.Converters"
             x:Class="eFinance.Pages.RegisterPage">

    <ContentPage.Resources>
        <ResourceDictionary>

            <!-- Converters -->
            <conv:AmountColorConverter x:Key="AmountColorConverter" />
            <conv:AlternationIndexToRowColorConverter x:Key="RowAltConverter" />

            <!-- Local label styles -->
            <Style x:Key="RegisterTitleLabelStyle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="26" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="HorizontalTextAlignment" Value="Center" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#222222, Dark=#FFFFFF}" />
            </Style>

            <Style x:Key="RegisterHeaderLabelStyle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#222222, Dark=#FFFFFF}" />
            </Style>

            <Style x:Key="RegisterCellLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="13" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
            </Style>

            <!-- Row container style -->
            <Style x:Key="RegisterRowBorderStyle" TargetType="Border">
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="8,6" />
                <Setter Property="Margin" Value="0,0,0,2" />
            </Style>

            <!-- Selected row highlight colors -->
            <Color x:Key="RowSelectedLight">#D6ECFF</Color>
            <Color x:Key="RowSelectedDark">#2D3F5C</Color>

            <!-- Header band colors -->
            <Color x:Key="HeaderBandLight">#EDEDED</Color>
            <Color x:Key="HeaderBandDark">#2B2B2B</Color>

            <Color x:Key="HeaderDividerLight">#CFCFCF</Color>
            <Color x:Key="HeaderDividerDark">#3A3A3A</Color>

        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Added a new top row for the centered title -->
    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*"
          Padding="16"
          RowSpacing="12">

        <!-- Centered Register Title -->
        <Label Grid.Row="0"
               Text="{Binding Title}"
               Style="{StaticResource RegisterTitleLabelStyle}" />

        <!-- Button bar -->
        <FlexLayout Grid.Row="1"
                    Direction="Row"
                    Wrap="Wrap"
                    AlignItems="Start"
                    JustifyContent="Start">

            <Button Text="Add New Transactions"
                    Margin="0,0,8,8"
                    Style="{StaticResource NeutralButtonStyle}"
                    Command="{Binding AddTransactionCommand}" />

            <Button Text="Edit Transaction"
                    Margin="0,0,8,8"
                    Style="{StaticResource NeutralButtonStyle}"
                    Command="{Binding EditTransactionCommand}" />

            <Button Text="Copy Transaction Description"
                    Margin="0,0,8,8"
                    Style="{StaticResource InfoButtonStyle}"
                    Command="{Binding CopyDescriptionCommand}" />

            <Button Text="Delete Transaction"
                    Margin="0,0,8,8"
                    Style="{StaticResource WarningButtonStyle}"
                    Command="{Binding DeleteSelectedCommand}" />

            <Button Text="Trash"
                    Margin="0,0,8,8"
                    Style="{StaticResource DangerButtonStyle}"
                    Command="{Binding OpenTrashCommand}" />

            <Button Text="Return"
                    Margin="0,0,8,8"
                    Style="{StaticResource ReturnButtonStyle}"
                    Command="{Binding ReturnCommand}" />

        </FlexLayout>

        <!-- Balance + Refresh (removed duplicate title here) -->
        <Grid Grid.Row="2"
              ColumnDefinitions="Auto,Auto,*,Auto"
              ColumnSpacing="10"
              VerticalOptions="Center">

            <Label Grid.Column="0"
                   Text="Balance ="
                   FontAttributes="Bold"
                   VerticalTextAlignment="Center"
                   TextColor="{AppThemeBinding Light=Black, Dark=White}" />

            <Label Grid.Column="1"
                   Text="{Binding CurrentBalance, StringFormat='{}{0:C}'}"
                   FontAttributes="Bold"
                   VerticalTextAlignment="Center"
                   TextColor="{Binding CurrentBalance, Converter={StaticResource AmountColorConverter}}" />

            <!-- spacer in column 2 -->

            <Button Grid.Column="3"
                    Text="Refresh"
                    Style="{StaticResource NeutralButtonStyle}"
                    Command="{Binding RefreshCommand}" />

        </Grid>

        <!-- Search box -->
        <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="10">

            <Border Grid.Column="0"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource SearchBorderLight},
                                            Dark={StaticResource SearchBorderDark}}"
                    Background="{AppThemeBinding Light={StaticResource SearchBgLight},
                                                Dark={StaticResource SearchBgDark}}"
                    StrokeShape="RoundRectangle 8"
                    Padding="10,6">

                <Entry Placeholder="Search transactions..."
                       PlaceholderColor="{AppThemeBinding Light=#6B6B6B, Dark=#9A9A9A}"
                       TextColor="{AppThemeBinding Light=Black, Dark=White}"
                       BackgroundColor="Transparent"
                       ClearButtonVisibility="WhileEditing"
                       Text="{Binding SearchText, Mode=TwoWay}"
                       ReturnType="Search"
                       Completed="SearchEntry_Completed" />
            </Border>

            <Button Grid.Column="1"
                    Text="Clear"
                    IsVisible="False" />
        </Grid>

        <!-- Sticky header + scrollable list -->
        <Grid Grid.Row="4" RowDefinitions="Auto,*">

            <!-- Sticky header -->
            <Border Grid.Row="0"
                    StrokeThickness="0"
                    Background="{AppThemeBinding Light={StaticResource HeaderBandLight},
                                                Dark={StaticResource HeaderBandDark}}"
                    Padding="8,8">

                <VerticalStackLayout Spacing="6">

                    <Grid ColumnDefinitions="110,*,180,120,120">

                        <Label Text="DATE" Style="{StaticResource RegisterHeaderLabelStyle}" />
                        <Label Grid.Column="1" Text="DESCRIPTION" Style="{StaticResource RegisterHeaderLabelStyle}" />
                        <Label Grid.Column="2" Text="CATEGORY" Style="{StaticResource RegisterHeaderLabelStyle}" />
                        <Label Grid.Column="3" Text="AMOUNT" Style="{StaticResource RegisterHeaderLabelStyle}" HorizontalTextAlignment="End" />
                        <Label Grid.Column="4" Text="BALANCE" Style="{StaticResource RegisterHeaderLabelStyle}" HorizontalTextAlignment="End" />

                    </Grid>

                    <BoxView HeightRequest="1"
                             BackgroundColor="{AppThemeBinding Light={StaticResource HeaderDividerLight},
                                                             Dark={StaticResource HeaderDividerDark}}" />
                </VerticalStackLayout>

            </Border>

            <!-- Scrollable list -->
            <CollectionView x:Name="RegisterCollection"
                            Grid.Row="1"
                            ItemsSource="{Binding Items}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedRow, Mode=TwoWay}">

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource RegisterRowBorderStyle}"
                                HorizontalOptions="FillAndExpand">

                            <!-- Row striping -->
                            <Border.Background>
                                <SolidColorBrush Color="{Binding RowIndex, Converter={StaticResource RowAltConverter}}" />
                            </Border.Background>

                            <!-- Selected row highlight -->
                            <Border.Triggers>
                                <DataTrigger TargetType="Border"
                                             Binding="{Binding IsSelected}"
                                             Value="True">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <SolidColorBrush Color="{AppThemeBinding Light={StaticResource RowSelectedLight},
                                                                             Dark={StaticResource RowSelectedDark}}" />
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="StrokeThickness" Value="2" />
                                    <Setter Property="Stroke"
                                            Value="{AppThemeBinding Light=#0078D4, Dark=#6CB8FF}" />
                                </DataTrigger>
                            </Border.Triggers>

                            <Grid ColumnDefinitions="110,*,180,120,120"
                                  HorizontalOptions="FillAndExpand">

                                <Label Text="{Binding PostedDate}"
                                       Style="{StaticResource RegisterCellLabelStyle}" />

                                <Label Grid.Column="1"
                                       Text="{Binding Description}"
                                       LineBreakMode="TailTruncation"
                                       Style="{StaticResource RegisterCellLabelStyle}" />

                                <Label Grid.Column="2"
                                       Text="{Binding Category}"
                                       LineBreakMode="TailTruncation"
                                       Style="{StaticResource RegisterCellLabelStyle}" />

                                <Label Grid.Column="3"
                                       Text="{Binding Amount, StringFormat='{}{0:C}'}"
                                       HorizontalTextAlignment="End"
                                       TextColor="{Binding Amount, Converter={StaticResource AmountColorConverter}}"
                                       Style="{StaticResource RegisterCellLabelStyle}" />

                                <Label Grid.Column="4"
                                       Text="{Binding Balance, StringFormat='{}{0:C}'}"
                                       HorizontalTextAlignment="End"
                                       TextColor="{Binding Balance, Converter={StaticResource AmountColorConverter}}"
                                       Style="{StaticResource RegisterCellLabelStyle}" />

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

            </CollectionView>

        </Grid>

    </Grid>
</ContentPage>